import sys
import os
import torch
from abc import ABC
from tqdm import tqdm
from torch.utils.data import Dataset

sys.path.append('./')
from megatron import get_args
from megatron.core import mpu
from megatron import get_tokenizer
from megatron.model import GPTModel
from megatron.training import get_model
from megatron.checkpointing import load_checkpoint
from megatron.initialize import initialize_megatron
from megatron.arguments import core_transformer_config_from_args
from megatron.text_generation import generate_and_post_process
from megatron.text_generation import beam_search_and_post_process


def model_provider(pre_process=True, post_process=True):
    config = core_transformer_config_from_args(get_args())
    model = GPTModel(config, num_tokentypes=0, parallel_output=False, pre_process=pre_process, post_process=post_process)
    return model

def add_text_generate_args(parser):
    group = parser.add_argument_group(title='text generation')
    group.add_argument('--max_len', type=int, default=1024)
    group.add_argument('--model_config_path', type=str, default='./')
    group.add_argument('--math_datapath', type=str, default='./')
    group.add_argument('--output_path', type=str, default='./')
    group.add_argument('--num_samples_per_task', type=int, default=10)
    group.add_argument('--top_k', type=int, default=0)
    group.add_argument('--top_p', type=float, default=0.95)
    group.add_argument('--top_p_decay', type=float, default=0.0)
    group.add_argument('--top_p_bound', type=float, default=0.0)
    group.add_argument('--temp', type=float, default=0.5)
    group.add_argument('--min_length', type=int, default=0)
    group.add_argument('--random_seed', type=int, default=1234)
    group.add_argument('--beam_width', type=int, default=None)
    group.add_argument('--length_penalty', type=int, default=1)
    group.add_argument('--prevent_newline_after_colon', type=bool, default=False)
    return parser

def clean_tab(msg_text):
    __sep_note = "<n>"
    msg_text = msg_text.replace("\n", __sep_note)
    msg_text = msg_text.replace(__sep_note + __sep_note, __sep_note)
    msg_text = msg_text.replace(__sep_note + __sep_note, __sep_note)
    msg_text = msg_text.replace(__sep_note + __sep_note, __sep_note)
    return msg_text

class EvalDataset(ABC, Dataset):
    def __init__(self, data_path):
        self.problems = []
        self.keys = []
        self.answers = []

        with open(data_path, 'r') as f:
            lines = f.readlines()
            for ii, line in enumerate(lines):
                line = line.strip()
                index = line.find('[SEP]')
                prompt = '''Question:Which environmental consequence is not associated with the disposal of plastic waste in the ocean?<n>A. It forms large garbage patches in the ocean.<n>B. It breaks down and releases toxic chemicals.<n>C. It provides a habitat for marine life.<n>D. It entangles marine animals, causing injury or death.<n>Answer:This question is assessing knowledge of environmental consequences related to the disposal of plastic waste in the ocean. Let's analyze each option:<n>A. - This is a valid environmental consequence associated with the disposal of plastic waste, as it can accumulate in large patches in the ocean.<n>B. - This is also a valid consequence because plastic waste can break down over time and release harmful chemicals into the ocean.<n>C. - This statement is incorrect. Plastic waste does not typically provide a suitable habitat for marine life; instead, it can harm marine ecosystems.<n>D. - This is another valid consequence as marine animals can become entangled in plastic waste, leading to injury or death.<n>Based on the analysis, the correct answer is:<n>C.<n>Question:Which scientific method term describes the following statement: "The substance in a test tube is undergoing a chemical change based on observing bubbling and color change"?<n>A. Observation<n>B. Hypothesis<n>C. Conclusion<n>D. Inference<n>Answer: D. Inference<n>Answer:The question is asking for the scientific method term that describes the given statement. Let's analyze the options:<n>A. An observation is a statement based on something one has seen, heard, or noticed. It involves gathering data through the senses. The given statement is not just an observation but an interpretation based on the observation.<n>B. A hypothesis is a proposed explanation made on the basis of limited evidence as a starting point for further investigation. The given statement does not propose an explanation or prediction but rather draws a conclusion based on the observation.<n>C. A conclusion is a judgment or decision reached by reasoning after consideration of the evidence. The given statement itself is a conclusion based on the observation made.<n>D. Inference: An inference is a conclusion reached on the basis of evidence and reasoning. The given statement, which infers that the substance in the test tube is undergoing a chemical change based on the observed bubbling and color change, aligns with the definition of an inference.<n>Therefore, the correct answer is:<n>D. Inference.<n>Question:An astronomical unit (AU) is the average distance from the Earth to the Sun, which is approximately 93 million miles. It takes about 8 minutes for the energy from the Sun to reach Earth. If Neptune is 30 AU from the Sun, how many minutes will it take the Sun's energy to reach Neptune?<n>A. 180 minutes<n>B. 240 minutes<n>C. 360 minutes<n>D. 480 minutes<n>Answer:The question asks for the time it takes for the Sun's energy to reach Neptune, which is 30 AU from the Sun. Since it takes about 8 minutes for the energy from the Sun to reach Earth (1 AU), we can calculate the time it takes for the energy to reach Neptune by multiplying the distance in AU by the time it takes to reach Earth.<n>So, 30 AU * 8 minutes = 240 minutes.<n>Therefore, the correct answer is:<n>B. 240 minutes.<n>Question:Which of these is a physical change that occurs in a forest?<n>A. Birds build nests in the trees for shelter.<n>B. Leaves change color in the fall before falling to the ground.<n>C. Mushrooms release spores into the air for reproduction.<n>D. Trees absorb carbon dioxide and release oxygen through photosynthesis.<n>Answer:This question evaluates understanding of physical changes in a forest. Let's examine each option:<n>A.- This describes a behavioral action of birds constructing nests. It is not a physical change.<n>B.- This describes a physical change where leaves undergo color transformation before dropping from trees. This is a correct option.<n>C.- This describes a biological process where mushrooms disperse reproductive spores. It is not a physical change.<n>D.- This describes a physiological process (photosynthesis) where trees exchange gases with the environment. It is not a physical change.<n>Correct option: B. <n>So, the correct answer is option B.<n>Question:What is the primary function of skin cells?<n>A.to deliver messages to the brain<n>B.to generate movement of muscles<n>C.to provide a physical barrier to the body<n>D.to produce carbohydrates for energy<n>Answer:The question asks about the primary function of skin cells, which requires an understanding of basic human anatomy and physiology. Let's break down each option:<n>A. To deliver messages to the brain - This is the function of neurons and the nervous system, not skin cells.<n>B. To generate movement of muscles - Muscle cells (myocytes) are responsible for generating movement, not skin cells.<n>C. To provide a physical barrier to the body - This is correct. The primary function of skin cells (such as keratinocytes) is to form a protective barrier against physical, chemical, and microbial threats.<n>D. To produce carbohydrates for energy - Carbohydrate metabolism primarily occurs in cells of the liver and muscles, not in skin cells.<n>Therefore, the correct answer is **C. to provide a physical barrier to the body**.<n>Question:What phenomenon causes only one side of the Moon to be visible from Earth?<n>A. The Moon's lack of rotation on its axis.<n>B. The Moon's invisibility during the day.<n>C. The Moon's changing phases that coincide with its rotation.<n>D. The Moon's synchronous rotation with its revolution around Earth.<n>Answer:The correct answer to the question is D. "The Moon's synchronous rotation with its revolution around Earth."<n>Analysis:<n>The phenomenon where only one side of the Moon is visible from Earth is due to synchronous rotation, meaning the Moon rotates on its axis at the same rate that it revolves around the Earth. As a result, the same side of the Moon always faces Earth, while the other side remains permanently hidden from view. This synchronous rotation is the reason why we only ever see one side of the Moon from Earth. Therefore, option D accurately explains this phenomenon.<n>Question:Which of the following is a potential negative impact of constructing a dam on a river?<n>A. Prevents sediment from flowing downstream.<n>B. Increases the amount of water available to farms.<n>C. Prevents seasonal downstream flooding.<n>D. Increases the rate of water loss from a lake.<n>Answer:The question is asking about a potential negative impact of constructing a dam on a river. Let's analyze each option:<n>A. This is a potential negative impact because sediment flowing downstream is important for replenishing nutrients in downstream ecosystems and maintaining the health of habitats such as river deltas. Therefore, this option could be correct.<n>B. This option describes a potential positive impact of building a dam, not a negative impact. It increases water availability for irrigation, which is generally seen as beneficial for agriculture.<n>C. This is also a potential positive impact of building a dam, as it can control the flow of water and reduce the risk of flooding downstream. Therefore, it is not a negative impact.<n>D. This option describes a potential negative impact of building a dam, as it can lead to increased evaporation from the reservoir behind the dam. However, it's important to note that this is not as commonly cited as the negative impact mentioned in option A.<n>Based on the analysis, the correct answer is:<n>A.<n>Question:Michael's family is building a new house. They would like to use electricity generated by renewable resources. Which of these power supplies would help the family accomplish its goal?<n>A.gasoline engine<n>B.solar roof panels<n>C.coal power plant<n>D.nuclear power plant<n>Answer:The question is asking which power supply option would help Michael's family accomplish their goal of using electricity generated by renewable resources. <n>Let's analyze each option:<n>A. Gasoline engine: Gasoline engines typically burn fossil fuels and are not considered renewable energy sources. Therefore, this option does not align with the goal of using electricity from renewable resources.<n>B. Solar roof panels: Solar panels convert sunlight into electricity and are a renewable energy source. Installing solar roof panels would indeed help Michael's family achieve their goal of using electricity generated by renewable resources.<n>C. Coal power plant: Coal power plants burn coal to generate electricity, which is not a renewable energy source. Therefore, this option does not align with the goal stated in the question.<n>D. Nuclear power plant: Nuclear power plants generate electricity through nuclear reactions, which do not rely on fossil fuels but are not considered renewable energy sources. Therefore, this option also does not align with the goal of using electricity from renewable resources.<n>So, the correct answer is B. solar roof panels.<n>Question:What is the reason for an ice cube to melt when held in a person's hand?<n>A. Heat moves from the person's hand to the ice cube.<n>B. Cold moves from the person's hand to the ice cube.<n>C. Heat moves from the ice cube to the person's hand.<n>D. Cold moves from the ice cube to the person's hand.<n>Answer:The correct answer is A. Heat moves from the person's hand to the ice cube.<n>When a person holds an ice cube, the heat from their hand is transferred to the ice cube. Heat always moves from a warmer object to a cooler object. In this case, the person's hand is warmer than the ice cube, so the heat flows from their hand to the ice cube. As a result, the ice cube absorbs the heat energy, causing it to melt. Cold does not actually "move," but rather, it is the absence of heat. So, it is more accurate to say that heat moves from the hand to the ice cube, causing it to melt.<n>Question:During a solar eclipse, in what order are the Sun, Moon, and Earth aligned?<n>A) Sun-Moon-Earth <n>B) Earth-Sun-Moon <n>C) Moon-Earth-Sun <n>D) Earth-Moon-Sun<n>Answer:During a solar eclipse, the Sun, Moon, and Earth are aligned in a specific way such that the Moon comes between the Earth and the Sun, blocking the sunlight. <n>Let's analyze the question and the provided options:<n>- Option A: Sun-Moon-Earth - This arrangement has the Sun between the Moon and the Earth, which is not the correct alignment for a solar eclipse.<n>- Option B: Earth-Sun-Moon - This arrangement has the Earth between the Sun and the Moon, which is not the correct alignment for a solar eclipse.<n>- Option C: Moon-Earth-Sun - This arrangement has the Moon between the Earth and the Sun, which is the correct alignment for a solar eclipse.<n>- Option D: Earth-Moon-Sun - This arrangement has the Earth between the Moon and the Sun, which is not the correct alignment for a solar eclipse.<n>Thus, the correct answer to the question is Option C: Moon-Earth-Sun.<n>Question:Which leaf adaptation is most beneficial for plants in arid environments?<n>A. Red and shiny.<n>B. Wide and flat.<n>C. Thick and waxy.<n>D. Soft and fuzzy.<n>Answer: C. Thick and waxy.<n>Answer:This question assesses knowledge of leaf adaptations suited for arid environments. Let's analyze each option:<n>A.  Red and shiny leaves are not typically adaptations for arid environments. Shiny leaves may indicate a waxy cuticle, but the color red is not directly associated with aridity adaptation.<n>B.  Wide and flat leaves are more suited for capturing sunlight and rainwater, making them better adapted to wetter environments rather than arid ones.<n>C.  Thick and waxy leaves help reduce water loss through transpiration, which is crucial in arid environments where water is scarce. This option seems to align with adaptations beneficial for plants in arid climates.<n>D. Soft and fuzzy: Soft and fuzzy leaves are not typically adaptations for arid environments. These characteristics might be more suited for plants in cooler or shadier conditions where trapping moisture or warmth is advantageous.<n>Based on this analysis, the correct answer is **C. Thick and waxy**, as it best aligns with leaf adaptations that benefit plants in arid environments by reducing water loss.<n>Question:Wind energy is a renewable source of power that is harnessed from the wind using wind turbines. How does the utilization of wind energy positively impact the environment?<n>A. Increases greenhouse gas emissions<n>B. Reduces dependence on fossil fuels<n>C. Contributes to deforestation<n>D. Accelerates soil erosion<n>Answer:The question addresses the positive environmental impact of utilizing wind energy. Let's analyze each option:<n>A. Increases greenhouse gas emissions: This is unlikely because wind energy production does not emit greenhouse gases during operation. In fact, it helps reduce greenhouse gas emissions by displacing the need for fossil fuel-based energy generation.<n>B. Reduces dependence on fossil fuels: This is a strong contender. Wind energy is renewable and does not require the burning of fossil fuels, thus reducing reliance on non-renewable resources and mitigating environmental pollution.<n>C. Contributes to deforestation: This is unlikely as wind energy production typically involves erecting turbines on land or offshore areas, not in forests where deforestation occurs.<n>D. Accelerates soil erosion: This is improbable because wind energy infrastructure typically does not disturb large amounts of land or contribute significantly to soil erosion. <n>Based on the analysis, the correct answer is:<n>B. Reduces dependence on fossil fuels<n>Question:In a small kitchen, a set of shelves is installed above the countertop. These shelves are an example of<n>A. making the wall stronger.<n>B. using storage space efficiently.<n>C. using a countertop for more than one purpose.<n>D. solving the need for shelter in a creative way.<n>Answer:The question is asking for an analysis of the purpose of shelves installed above the countertop in a small kitchen. Let's break down the options:<n>A. Making the wall stronger: This option doesn't directly relate to the purpose of the shelves above the countertop. The shelves are primarily for storage, not for strengthening the wall.<n>B. Using storage space efficiently: This option seems to align with the purpose of the shelves. Placing shelves above the countertop allows for the efficient use of vertical space for storage.<n>C. Using a countertop for more than one purpose: While the countertop serves its primary purpose for food preparation and other activities, the shelves above it serve a different purpose related to storage. This option does not accurately describe the function of the shelves.<n>D. Solving the need for shelter in a creative way: This option does not seem to be related to the purpose of the shelves in the kitchen.<n>Based on the analysis, the correct answer is B.<n>Question:Arrange the following planets in order from closest to farthest from the Sun.<n>A.Mars, Venus, Earth, Jupiter<n>B.Venus, Earth, Mars, Jupiter<n>C.Mars, Earth, Venus, Jupiter<n>D.Earth, Mars, Venus, Jupiter<n>Answer:The question is asking to arrange the planets in order from closest to farthest from the Sun. Let's analyze the distances of the planets:<n>1. Mercury is the closest planet to the Sun.<n>2. Venus comes after Mercury.<n>3. Earth follows Venus.<n>4. Mars is farther from the Sun than Earth.<n>5. Jupiter is the farthest of the listed planets from the Sun.<n>So, the correct order from closest to farthest from the Sun is: B. Venus, Earth, Mars, Jupiter.<n>Question:A research study concluded that individuals who consume more than three cups of coffee per day are at a higher risk of developing insomnia. This conclusion was developed from a study of 300 adults of different ages. How is this investigation biased?<n>A. The sample size was too small.<n>B. Scientists did not run the study.<n>C. Individuals who consume tea were excluded from the study.<n>D. No information was collected about the participants' sleep patterns.<n>Answer:The investigation described in the question suffers from bias due to option C: ""<n>This bias arises because the study only focused on individuals who consume coffee, which means the findings cannot be generalized to the broader population that includes tea drinkers. Therefore, any conclusions drawn from this study about the relationship between coffee consumption and insomnia risk may not be applicable to individuals who primarily consume tea. This limitation reduces the study's validity and reliability.<n>So, the correct answer is C.<n>Question:Which of the following elements is least likely to be found in a sample of coal?<n>A. nitrogen<n>B. oxygen<n>C. gold<n>D. sulfur<n>Answer:The question is assessing knowledge of the composition of coal, a natural material formed from ancient organic compounds. Coal primarily consists of carbon, hydrogen, sulfur, and other elements. Among the options provided, gold is least likely to be found in a sample of coal, as it is not typically associated with organic matter or coal formation processes.<n>So, the correct answer is:<n>C. gold.<n>Question:What is the most likely reason for the similarity in needle length among balsam fir trees in Maine?<n>A. because of the amount of sunlight they receive<n>B. because of their closeness to the ocean<n>C. because of the inherited information inside the seeds<n>D. because of the type of insects that eat the needles<n>Answer:The most likely reason for the similarity in needle length among balsam fir trees in Maine is due to the inherited information inside the seeds (Option C). This inherited genetic information leads to consistent traits, including needle length, among the balsam fir trees in the region.<n>Therefore, the correct answer is:<n>C. because of the inherited information inside the seeds.<n>Question:Which of the following best describes what a scientist means when they calculate a distance of 8.6 light-years?<n>A. Diameter of the Milky Way galaxy<n>B. Length of a year on Saturn<n>C. Distance between the Earth and the Moon<n>D. Distance between the Sun and the nearest star<n>Answer:The calculation of 8.6 light-years likely represents:<n>D. Distance between the Sun and the nearest star<n>This is because a light-year is a unit of distance, representing the distance that light travels in one year. Therefore, when a scientist calculates a distance in light-years, it typically refers to the distance light would travel in that time frame. In this case, 8.6 light-years likely indicates the distance between the Sun and the nearest star, as it's a common unit used in astronomy to measure vast distances in space.<n>Question:Researchers observe a colonyof penguins in Antarctica, monitoring their breeding patterns over several years. What are they most likely trying to understand?<n>A. How many penguins are surviving the harsh climate?<n>B. How have changes in ocean currents affected the ice formations?<n>C. How much food have the penguins consumed during the breeding season?<n>D. How is the seal population in the region adapting to climate change?<n>Answer:This question presents a scenario where researchers are studying a colony of penguins in Antarctica, specifically focusing on monitoring their breeding patterns over several years. To analyze the question:<n>A. "How many penguins are surviving the harsh climate?" - This option addresses the impact of the harsh climate conditions in Antarctica on penguin survival. Since the researchers are monitoring the penguins' breeding patterns over time, they may be interested in understanding how these harsh conditions affect the overall survival of the penguin population.<n>B. "How have changes in ocean currents affected the ice formations?" - This option pertains to investigating the relationship between changes in ocean currents and their impact on ice formations in Antarctica. While this information could be relevant to understanding the broader environmental context, it does not directly align with the researchers' focus on studying penguin breeding patterns.<n>C. "How much food have the penguins consumed during the breeding season?" - This option focuses on monitoring the food consumption of penguins during the breeding season. While food availability is undoubtedly an important factor for penguins' reproductive success, it may not be the primary focus of the researchers' study, which is specifically described as monitoring breeding patterns.<n>D. "How is the seal population in the region adapting to climate change?" - This option considers the adaptation of the seal population to climate change in the Antarctic region. While this may be an interesting area of research, it does not directly relate to the researchers' primary focus on studying penguin breeding patterns.<n>Considering the context provided in the question, the most likely objective of the researchers is to understand how the breeding patterns of the penguin colony are influenced by various factors, including environmental conditions. Therefore, the correct answer is:<n>A. How many penguins are surviving the harsh climate?<n>This option aligns with the researchers' activity of monitoring penguin breeding patterns in Antarctica over several years, with a likely interest in understanding the impact of the harsh climate on penguin survival.<n>Question:Sodium has an atomic mass of 23, and chlorine has an atomic mass of 35. When a salt molecule forms, one sodium atom combines with one chlorine atom. What is the mass of a salt molecule?<n>A. 23 <n>B. 35 <n>C. 46 <n>D. 58<n>Answer:The question is asking about the mass of a salt molecule formed by the combination of sodium and chlorine atoms. To find the mass of a salt molecule (NaCl), we simply add the atomic masses of the constituent atoms.<n>Given:<n>- Atomic mass of sodium (Na) = 23<n>- Atomic mass of chlorine (Cl) = 35<n>A salt molecule (NaCl) consists of one sodium atom and one chlorine atom.<n>Mass of NaCl = Mass of Na + Mass of Cl<n>= 23 + 35<n>= 58<n>So, the correct answer is:<n>D. 58.<n>Question:Which statement accurately describes the chemical equation \\( 2H_{2}O(l) \\rightarrow 2H_{2}(g) + O_{2}(g) \\)?<n>A. A gas is produced.<n>B. Energy is absorbed.<n>C. Energy is released.<n>D. Equal numbers of molecules are on both sides of the arrow.<n>Answer:Let's analyze the chemical equation provided:<n>\\[ 2H_{2}O(l) \\rightarrow 2H_{2}(g) + O_{2}(g) \\]<n>This equation represents the decomposition of water (\\( H_{2}O \\)) into hydrogen gas (\\( H_{2} \\)) and oxygen gas (\\( O_{2} \\)). <n>Now, let's consider each statement:<n>A.- This statement is correct. Both hydrogen gas (\\( H_{2} \\)) and oxygen gas (\\( O_{2} \\)) are produced as products in the gaseous state.<n>B.- This statement is incorrect. There is no indication of energy being absorbed in the equation. Typically, energy absorption would be represented by a reactant or a change in the equation.<n>C.- This statement is incorrect. Similar to option B, there is no indication of energy being released in the equation.<n>D.- This statement is incorrect. The number of molecules is not balanced on both sides of the equation. On the reactant side, there is 1 molecule of \\( H_{2}O \\), while on the product side, there are 2 molecules of \\( H_{2} \\) and 1 molecule of \\( O_{2} \\).<n>So, the correct answer is:<n>\\[ \\text{A. } \\]<n>Question:Which of the following is a process common to all cells?<n>A. Protein synthesis<n>B. Cell division<n>C. Energy release<n>D. Waste elimination<n>Answer:This question is asking about a process that is universally shared by all cells. Let's analyze each option:<n>A. While protein synthesis is a fundamental process in cells, not all cells actively engage in this process at all times. Some cells may be dormant or specialized for other functions.<n>B. While cell division is essential for the growth and reproduction of most cells, there are some exceptions, such as mature nerve cells (neurons) in humans, which typically do not undergo cell division.<n>C. All cells require energy to perform their functions, and energy release is a fundamental process in cellular metabolism. Cells generate energy through processes like cellular respiration or photosynthesis.<n>D. All cells produce waste products as part of their metabolic activities, and eliminating these wastes is essential for cellular health and function. Cells use various mechanisms, such as exocytosis, diffusion, and active transport, to remove waste products.<n>Among the options provided, the only process that is universally common to all cells is:<n>C. Energy release<n>So, the correct answer is:<n>C. Energy release.<n>Question:Jamie wants to test if the type of surface affects how far a ball rolls. She rolls three balls across different surfaces and measures the distance each ball rolls. Which part of the experiment should Jamie keep the same for each ball?<n>A. The type of ball used<n>B. The length of the surface<n>C. The type of surface each ball rolls on<n>D. The distance each ball rolls<n>Answer:To determine which part of the experiment Jamie should keep the same, let's examine the options:<n>A. **The type of ball used**: This is a factor that should be consistent across all trials to ensure that any variation in rolling distance is due to the type of surface, not the type of ball. Using the same type of ball eliminates it as a potential source of variation.<n>B. **The length of the surface**: This isn't necessarily a variable that needs to be controlled, as Jamie's focus is on different surfaces, not on specific surface lengths.<n>C. **The type of surface each ball rolls on**: This is the variable Jamie is testing (independent variable), so it should not be kept the same. Changing the type of surface allows her to determine how it affects the rolling distance of the balls.<n>D. **The distance each ball rolls**: This is the outcome Jamie is measuring (dependent variable), not something that should be controlled. It reflects the result of the experiment based on the type of surface.<n>Given this analysis, the correct answer is:<n>A. **The type of ball used**.<n>Question:Mary drove a car for two hours at a rate of 60 kilometers per hour. The next hour, she drove at 80 kilometers per hour. What was her average speed during those three hours?<n>A. 60 kilometers per hour<n>B. 70 kilometers per hour<n>C. 80 kilometers per hour<n>D. 100 kilometers per hour<n>Answer:To find the average speed, we need to calculate the total distance traveled and divide it by the total time taken.<n>In the first two hours, Mary drove at a rate of so she traveled a distance of 60 km/h * 2 h = 120 kilometers in those two hours.<n>In the third hour, she drove at a rate of so she traveled a distance of 80 kilometers in that hour.<n>The total distance traveled is 120 + 80 = 200 kilometers.<n>The total time taken is 2 + 1 = 3 hours.<n>To find the average speed, we divide the total distance by the total time:<n>Average speed = Total distance / Total time = 200 kilometers / 3 hours â‰ˆ 66.67 kilometers per hour.<n>Therefore, the closest option to the average speed is A.<n>Question:Prairie dogs are keystone species in grassland ecosystems, creating complex underground burrow systems. Due to habitat destruction and extermination programs, prairie dog populations have declined in certain regions. What is an ecological consequence that is most likely to occur with a decrease in the prairie dog population?<n>A. An increase in biodiversity within the grassland ecosystem.<n>B. A decrease in soil erosion rates.<n>C. An increase in the population of grass-eating herbivores.<n>D. A decrease in the availability of nesting sites for burrowing owls.<n>Which option do you think is correct?<n>Answer:This question discusses the ecological consequences of a decrease in prairie dog populations in grassland ecosystems. Prairie dogs are known for creating complex underground burrow systems, which have significant ecological impacts. Let's analyze each option:<n>A.  This is unlikely because prairie dogs themselves contribute to biodiversity by creating habitats for a variety of other species, such as burrowing owls and certain reptiles. Therefore, a decrease in prairie dog populations would likely lead to a decrease in biodiversity rather than an increase.<n>B.  This is unlikely because prairie dog burrows help to aerate and stabilize the soil, reducing erosion rates. Therefore, a decrease in prairie dog populations would likely lead to an increase in soil erosion rates rather than a decrease.<n>C.  This is unlikely because a decrease in prairie dog populations would not directly affect the population of grass-eating herbivores. In fact, the presence of prairie dogs may indirectly benefit herbivores by improving grassland habitat quality.<n>D. A decrease in the availability of nesting sites for burrowing owls: This is the most likely consequence of a decrease in the prairie dog population. Burrowing owls often use abandoned prairie dog burrows as nesting sites. Therefore, a decline in prairie dog populations would likely lead to a decrease in the availability of nesting sites for burrowing owls.<n>So, the correct answer is:<n>D. A decrease in the availability of nesting sites for burrowing owls.<n>Question:'''
                line = prompt + line[:index] + '<sep>'
                line = line.replace('<n>', '\n')
                self.problems.append(line)
                self.keys.append(ii)
                self.answers.append('')

    def __len__(self):
        return len(self.problems)

    def __getitem__(self, idx):
        try:
            key = self.keys[idx]
            sample = self.problems[key]
        except Exception as e:
            print(e, idx, len(self.problems))
            exit()
        return {'task_id':key, 'sample':sample}


def main():
    initialize_megatron(extra_args_provider=add_text_generate_args,
                        args_defaults={'tokenizer_type': 'YuanTokenizer',
                                       'no_load_rng': True,
                                       'no_load_optim': True})
    args = get_args()
    dataset = EvalDataset(args.math_datapath)
    sampler = torch.utils.data.distributed.DistributedSampler(dataset, rank=mpu.get_data_parallel_rank(), num_replicas = mpu.get_data_parallel_world_size(), shuffle=False, drop_last=False)
    data_loader = torch.utils.data.DataLoader(dataset,
            batch_size=args.micro_batch_size,
            sampler=sampler,
            num_workers=args.num_workers,
            shuffle=False,
            pin_memory=True,
            drop_last=False,
            prefetch_factor=2)
    model = get_model(model_provider, wrap_with_ddp=False)
    if args.load is not None:
        _ = load_checkpoint(model, None, None)
    assert len(model) == 1, "Above condition should have caught this"
    model = model[0]
    tokenizer = get_tokenizer()
    tokenizer.add_eos_token = False
    tokenizer.add_bos_token = False
    tokenizer.eod = tokenizer.convert_tokens_to_ids(tokenizer.eos_token)
    stop_token = tokenizer.convert_tokens_to_ids(tokenizer.eos_token)
    tokenizer.add_special_tokens({'pad_token': '<pad>'})
    torch.distributed.barrier()
    model.eval()
    if args.fp16:
        model = model.half()
    elif args.bf16:
        model = model.bfloat16()
    else:
        model = model.float()
    model.cuda()
    torch.distributed.barrier()
    if torch.distributed.get_rank()==0 and not os.path.exists(args.output_path):
        os.makedirs(args.output_path)

    with torch.no_grad():
        data_iter = tqdm(enumerate(data_loader), total=len(data_loader)) if torch.distributed.get_rank()==0 else enumerate(data_loader)
        for i, batch in data_iter:
            sample_iter = tqdm(range(args.num_samples_per_task), total=args.num_samples_per_task) if torch.distributed.get_rank()==0 else  range(args.num_samples_per_task)
            for j in sample_iter:
                def inference_once(top_k=None, top_p=None, temp=None, seed=None):
                    tokens = tokenizer(batch['sample'], return_tensors='pt', padding=True).input_ids[:,:-1].to(torch.cuda.current_device())
                    if args.beam_width is not None:
                        response, response_seg, response_scores = \
                            beam_search_and_post_process(
                            model,
                            prompts=batch['sample'],
                            tokens_to_generate=(args.max_len - len(tokens)),
                            beam_size = args.beam_width,
                            add_BOS=False,
                            stop_token=stop_token,
                            num_return_gen=args.beam_width,
                            length_penalty=args.length_penalty,
                            prevent_newline_after_colon=args.prevent_newline_after_colon
                            )
                    else:
                        response, response_seg, response_logprobs, _ = \
                            generate_and_post_process(
                            model,
                            prompts=batch['sample'],
                            tokens_to_generate=(args.max_len - len(tokens)),
                            return_output_log_probs=False,
                            top_k_sampling=top_k,
                            top_p_sampling=top_p,
                            top_p_decay=args.top_p_decay,
                            top_p_bound=args.top_p_bound,
                            temperature=temp,
                            add_BOS=False,
                            stop_on_eol=False,
                            prevent_newline_after_colon=args.prevent_newline_after_colon,
                            random_seed=seed)

                    if mpu.is_pipeline_first_stage() and mpu.get_tensor_model_parallel_rank() == 0:
                        if response[0][0]==' ':
                            response = [response[0][1:-5]]
                        else:
                            response = [response[0][0:-5]]
                        new_sample = response
                        print('\n' + response[0])

                        with open(os.path.join(args.output_path, f'samples_{args.rank}.jsonl'), 'a', encoding='utf-8') as fp:
                            for _, x in enumerate(new_sample):
                                res = x.strip()
                                res = res.replace('<pad>', '')
                                res = res.replace('<eod>', '')
                                res = res.replace('<sep>', '[SEP]')
                                res = clean_tab(res)
                                record_res = res.strip() + '\n'
                                fp.write(record_res)
                inference_once(top_k=args.top_k, top_p=args.top_p, temp=args.temp, seed=args.random_seed)
              
    torch.distributed.barrier()


if __name__ == '__main__':
    main()
